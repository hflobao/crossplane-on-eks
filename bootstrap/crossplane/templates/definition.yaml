apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xeks.{{ .Values.apiGroup }}
spec:
  defaultCompositionRef:
    name: xeks.{{ .Values.apiGroup }}
  connectionSecretKeys:
    - kubeconfig
  group: {{ .Values.apiGroup }}
  names:
    kind: XEKS
    plural: xeks
  claimNames:
    kind: eks
    plural: eks
  versions:
    - name: {{ .Values.apiVersion }}
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                parameters:
                  type: object
                  description: EKS configuration parameters.
                  properties:
                    id:
                      type: string
                      description: ID of this Cluster that other objects will use to refer to it.
                    authenticationMode:
                      description: Authentication mode for the EKS cluster.
                      type: string
                      default: {{ .Values.eks.authenticationMode }}
                    bootstrapClusterCreatorAdminPermissions:
                      description: Whether or not to bootstrap the access config values to the EKS cluster.
                      type: boolean
                      default: {{ .Values.eks.bootstrapClusterCreatorAdminPermissions }}
                    enabledClusterLogTypes:
                      description: List of the desired control plane logging to enable. For more information, see Amazon EKS Control Plane Logging.
                      type: array
                      items:
                        type: string
                      default:
                        {{- range .Values.eks.enabledClusterLogTypes }}
                        - {{ . }}
                        {{- end }}
                    endpointPrivateAccess:
                      description: Whether the Amazon EKS private API server endpoint is enabled.
                      type: boolean
                      default: {{ .Values.eks.endpointPrivateAccess }}
                    endpointPublicAccess:
                      description: Whether the Amazon EKS public API server endpoint is enabled.
                      type: boolean
                      default: {{ .Values.eks.endpointPublicAccess }}
                    iam:
                      type: object
                      description: IAM configuration to connect as ClusterAdmin.
                      properties:
                        clusterAdminRoleArn:
                          description: The IAM Role ARN to connect as ClusterAdmin.
                          type: string
                        clusterAdminUserArn:
                          description: The IAM User ARN to connect as ClusterAdmin.
                          type: string
                    region:
                      description: AWS Region where resources will be deployed.
                      type: string
                    {{- if .Values.networking.createVpc }}
                    vpcCidr:
                      description: The IPv4 CIDR block for the VPC.
                      type: string
                    {{- if .Values.networking.createPublicSubnets }}
                    {{- range $i, $cidr := .Values.networking.publicSubnetCidrs }}
                    publicSubnet{{ $i }}Cidr:
                      description: The IPv4 CIDR block for the Public Subnet {{ $i }}.
                      type: string
                    publicSubnet{{ $i }}Az:
                      description: The AZ for the Public Subnet {{ $i }}.
                      type: string
                    {{- end }}
                    {{- end }}
                    {{- if .Values.networking.createPrivateSubnets }}
                    {{- range $i, $cidr := .Values.networking.privateSubnetCidrs }}
                    privateSubnet{{ $i }}Cidr:
                      description: The IPv4 CIDR block for the Private Subnet {{ $i }}.
                      type: string
                    privateSubnet{{ $i }}Az:
                      description: The AZ for the Private Subnet {{ $i }}.
                      type: string
                    {{- end }}
                    {{- end }}
                    {{- else }}
                    subnets:
                      description: Subnets for the EKS cluster and node groups.
                      type: array
                      items:
                        type: string
                    {{- end }}
                    version:
                      description: Kubernetes version for the EKS cluster.
                      type: string
                      default: {{ .Values.eks.version }}
                    crossplaneVersion:
                      description: Crossplane version to be deployed.
                      type: string
                      default: {{ .Values.crossplane.version }}
                    {{- if .Values.providerUpboundAws.enabled }}
                    upjetProviderVersion:
                      description: Upjet Provider version to be deployed.
                      type: string
                      default: {{ .Values.providerUpboundAws.version }}
                    {{- end }}
                    {{- if .Values.providerKubernetes.enabled }}
                    kubernetesProviderVersion:
                      description: Kubernetes Provider version to be deployed.
                      type: string
                      default: {{ .Values.providerKubernetes.version }}
                    {{- end }}
                    {{- if .Values.providerHelm.enabled }}
                    helmProviderVersion:
                      description: Helm Provider version to be deployed.
                      type: string
                      default: {{ .Values.providerHelm.version }}
                    {{- end }}
                    {{- if .Values.argocd.enabled }}
                    argoCdVersion:
                      description: ArgoCD Chart version to be deployed.
                      type: string
                      default: {{ .Values.argocd.version }}
                    {{- end }}
                    writeConnectionSecretToRef:
                      description: Reference to a Secret where connection details should be written.
                      type: object
                      properties:
                        name:
                          type: string
                          description: The name of the secret.
                    deletionPolicy:
                      description: Deletion policy for the resources. 'Delete' will remove all resources, 'Orphan' will only remove the Kubernetes resource and leave cloud resources.
                      type: string
                      enum:
                        - Delete
                        - Orphan
                      default: {{ .Values.crossplane.deletionPolicy }}
                    providerConfigName:
                      description: Name of the Crossplane ProviderConfig to use for provisioning resources.
                      type: string
            status:
              description: A Status represents the observed state
              properties:
                eks:
                  description: Freeform field containing status information for eks
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
              type: object
